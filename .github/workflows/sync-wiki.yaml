name: Sync Wiki to Reddit

on:
  push:
    branches: [main]
    paths:
      - 'wiki/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch brno-awesome README
        run: |
          curl -sL https://raw.githubusercontent.com/scherrer-txt/brno-awesome/main/README.md \
            -o /tmp/brno-awesome.md || echo "" > /tmp/brno-awesome.md

      - name: Build and send to Windmill
        env:
          WINDMILL_TOKEN: ${{ secrets.WINDMILL_TOKEN }}
          WINDMILL_URL: ${{ secrets.WINDMILL_URL }}
        run: |
          # Auto-discover all wiki files and build JSON payload
          # This handles any .md or .yaml file in wiki/ directory

          # Start building the files object
          FILES_JSON="{}"

          # Find all .md files in wiki/ (not in subdirectories)
          for file in wiki/*.md; do
            if [ -f "$file" ]; then
              # Extract basename without extension as key
              key=$(basename "$file" .md)
              content=$(cat "$file")
              FILES_JSON=$(echo "$FILES_JSON" | jq --arg k "$key" --arg v "$content" '. + {($k): $v}')
            fi
          done

          # Find all .yaml files in wiki/ (like moderation_instructions.yaml)
          for file in wiki/*.yaml; do
            if [ -f "$file" ]; then
              key=$(basename "$file" .yaml)
              content=$(cat "$file")
              FILES_JSON=$(echo "$FILES_JSON" | jq --arg k "$key" --arg v "$content" '. + {($k): $v}')
            fi
          done

          # Handle config/ subdirectory specially (maps to config/pagename on Reddit)
          for file in wiki/config/*.yaml wiki/config/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # Remove extension
              key="${filename%.*}"
              # Prefix with config/ for Reddit wiki path
              key="config/$key"
              content=$(cat "$file")
              FILES_JSON=$(echo "$FILES_JSON" | jq --arg k "$key" --arg v "$content" '. + {($k): $v}')
            fi
          done

          # Add brno-awesome from external repo
          if [ -f "/tmp/brno-awesome.md" ]; then
            content=$(cat /tmp/brno-awesome.md)
            FILES_JSON=$(echo "$FILES_JSON" | jq --arg v "$content" '. + {"awesome": $v}')
          fi

          echo "Files to sync:"
          echo "$FILES_JSON" | jq 'keys'

          # Build final payload
          PAYLOAD=$(jq -n \
            --argjson files "$FILES_JSON" \
            --arg commit_sha "${{ github.sha }}" \
            --arg commit_message "${{ github.event.head_commit.message }}" \
            --arg repo_url "https://github.com/${{ github.repository }}" \
            '{
              reddit_resource: "$res:u/kerray/reddit_ponocny_bot",
              files: $files,
              subreddit: "brno",
              commit_sha: $commit_sha,
              commit_message: $commit_message,
              repo_url: $repo_url
            }')

          # Send to Windmill
          RESPONSE=$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $WINDMILL_TOKEN" \
            -d "$PAYLOAD" \
            "$WINDMILL_URL")

          echo "Windmill response:"
          echo "$RESPONSE" | jq .

          # Check for errors
          ERRORS=$(echo "$RESPONSE" | jq -r '.errors // 0')
          if [ "$ERRORS" != "0" ]; then
            echo "::error::Wiki sync had $ERRORS errors"
            exit 1
          fi
